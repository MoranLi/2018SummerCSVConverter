<!doctype html>
<head>
    <meta charset="utf-8"/>
    <title>Linking to Data Table</title>
    <link rel="stylesheet" type="text/css" href="lib/d3.parcoords.css">
    <link rel="stylesheet" type="text/css" href="lib/style.css">
    <link rel="stylesheet" type="text/css" href="lib/d3.slider.css">
    <script src="lib/d3.min.js"></script>
    <script src="lib/sylvester.src.js"></script>
    <script src="lib/d3.parcoords.js"></script>
    <script src="lib/divgrid.js"></script>
    <script src="lib/d3.slider.js"></script>
</head>

<body>
    <!-- use buttons for zooming, futrue add zooming -->
    <button id="Child0">switch first 10% child!</button>
    <button id="Child1">switch second 10% child!</button>
    <button id="Child2">switch third 10% child!</button>
    <button id="Child3">switch fourth 10% child!</button>
    <button id="Child4">switch fifth 10% child!</button>
    <button id="Child5">switch sixth 10% child!</button>
    <button id="Child6">switch seventh 10% child!</button>
    <button id="Child7">switch eighth 10% child!</button>
    <button id="Child8">switch ninth 10% child!</button>
    <button id="Child9">switch tenth 10% child!</button>
    <button id="parent">switch parent!</button>
    <div id="example" class="parcoords" style="height:350px;"></div>
    <div id="grid" style="position: relative; top:20px"></div>
    <script>

        var blue_to_brown = d3.scale.linear()
            .domain([0, 1000])
            .range(["steelblue", "brown"])
            .interpolate(d3.interpolateLab);

        var color = function(d) { return blue_to_brown(d["Name"]); };

        var parcoords = d3.parcoords()("#example")
            .color(color)
            .alpha(0.4);

        // copy of data load from data set
        var data;
        // current axis set
        var current_data;
        // max number of dimension shown in pc
        var max_dimension = 10;
        // total dimension of system
        var dimension;
        // record current level 
        var level;
        // final level achievable (log10(dimension))
        var final_level;
        // record index of parent
        var parent_index = []; 
        // record index of current data
        var current_index;
        //start revision of system
        var start_point;
        // end revision of system
        var end_point;
        // record current paris exist ()
        var current_pair;
        // parallel coordinate each path x axis
        var pathes = [];
        
    //*******************************************************************************
    // Main Function: load json file and read datafor visualise***
    //*******************************************************************************
        d3.json('data/camellia.json', function(raw_data) {

            // initialize global variable
            data = Object.assign(raw_data.clone_evolution)
            start_point = raw_data.min_revision
            end_point = raw_data.max_revision
            dimension = end_point-start_point+1
            level = 0;
            final_level = Math.round(Math.log10(dimension));
            current_index = 0;
            current_pair = {};

            // modify data to fit first level
            current_data = [];
            for(var i=0;i<raw_data.clone_evolution.length;i++){
                current_data.push(re_data(start_point,end_point,raw_data.clone_evolution[i]))
            }

            createParallelCoordinate(current_data);
            
            initializeButton();
            initializePathAxis();
            initializeZooming();
            
        });

        function re_data(start,end,chain){
            // returned data
            var newData = {};
            // j is the pointer loop through revisiob, assume the system start from revision 0
            var j = 0;
            // total dimension will been shown in the parallel coordination
            var temp_dimension;
            // if currently, the dimension between start and end is more than max dimension allowed
            if(max_dimension < end-start){
                temp_dimension = max_dimension
            }
            else{
                temp_dimension = end-start
            }
            // loop through each dimension range
            // i is the nth dimension range been calculate
            for(var i=0;i<=temp_dimension;i++){
                var index;
                // avoid situation divided by 0(start from revision 0) 
                if( i == 0 ){
                    index = start;
                }
                else {
                    // calculate index by range*i/10+start
                    index = Math.round((end-start)/temp_dimension*i+start);
                }
                var sum = 0;
                var num = 0;
                // calculate average of change count
                for(;j<index;j++){
                    var changecount = chain[j];
                    if (changecount>-1){
                        sum+=changecount;
                        num++;
                    }
                }
                // if the clone chain do not exist in the given range
                if(num == 0){
                    newData[index] = NaN;
                }
                // else set avarage of changecount
                else{
                    newData[index] = Math.round(sum/num);
                }
                // set j to index, start of next loop
                j = index;
            }
            // copy other field from original data
            newData["Name"] = chain["Name"];
            newData["StartRevision"] = chain ["StartRevision"];
            newData["EndRevision"] = chain["EndRevision"];
            return newData;
        }

        function switchData(where){
            // should not zoom out at root level
            if(level == 0 && where == -1){
                return;
            }
            // should not zoom in if reach leaf level
            if(level == final_level && where != -1){
                return;
            }
            // clear current display
            var myNode = document.getElementById("example");
            while (myNode.firstChild) {
                myNode.removeChild(myNode.firstChild);
            }

            // recreate parcoords
            parcoords = d3.parcoords()("#example")
                .color(color)
                .alpha(0.4);

            // clone data form source file
            new_data = Object.assign(data)

            // start and end index of zooming 
            var start_index,
                end_index;
            // case zoom out
            if(where == -1){
                // go back one level
                level--;
                // pop index of parent
                var parent = parent_index.pop();
                // reset current index
                current_index = parent;
                // calculate start / end index of its parent
                start_index = Math.round((dimension/Math.pow(10,level))*(parent)+start_point);
                end_index = Math.round((dimension/Math.pow(10,level))*(parent+1)+start_point);
                // if end_index is > total dimension 
                if(end_index> dimension){
                    end_index = dimension;
                }
            }
            else{
                // push current index to parent_index array, store for future zoom out
                parent_index.push(current_index);
                // set current index to index of where scroll in (button in)
                current_index = where;
                level++;
                // get start / end popint from data form last time
                start_index = parseInt(Object.keys(current_data[0])[where]);
                end_index = parseInt(Object.keys(current_data[0])[where+1]);
            }

            var mod_data = [];
            for(var i=0;i<new_data.length;i++){
                mod_data.push(re_data(start_index,end_index,new_data[i]))
            }
            current_data = mod_data

            createParallelCoordinate(mod_data);
        }

        function createParallelCoordinate(data){
            // initialize parallel coordinate
            parcoords
                .data(data)
                .hideAxis(["Name","StartRevision","EndRevision"])
                .smoothness(0)
                .nullValueSeparator("bottom")
                .render()
                .brushMode("1D-axes");

            //************************************************
            // create data table, row hover highlighting *****
            //************************************************
            var grid = d3.divgrid(["Name","StartRevision","EndRevision"]);
            d3.select("#grid")
                .datum(data.slice(0,20))
                .call(grid)
                .selectAll(".row")
                // TODO
                .on('click', function(d) { alert(d["Name"])})
                .on({
                    "mouseover": function(d) { parcoords.highlight([d]) },
                    "mouseout": parcoords.unhighlight
                });

            //************************************************
            // update data table on brush event **************
            //************************************************
            parcoords.on("brush", function(d) {
                d3.select("#grid")
                    .datum(d.slice(0,20))
                    .call(grid)
                    .selectAll(".row")
                    // TODO
                    .on('click', function(d) { alert(d["Name"])})
                    .on({
                        "mouseover": function(d) { parcoords.highlight([d]) },
                        "mouseout": parcoords.unhighlight
                    });
            });
        }

        function initializeButton() {
            // add event listener to each button
            // will remove in future, using zooming
            document.getElementById("Child0").addEventListener("click",function(){
                switchData(0);
            })
            document.getElementById("Child1").addEventListener("click",function(){
                switchData(1);
            })
            document.getElementById("Child2").addEventListener("click",function(){
                switchData(2);
            })
            document.getElementById("Child3").addEventListener("click",function(){
                switchData(3);
            })
            document.getElementById("Child4").addEventListener("click",function(){
                switchData(4);
            })
            document.getElementById("Child5").addEventListener("click",function(){
                switchData(5);
            })
            document.getElementById("Child6").addEventListener("click",function(){
                switchData(6);
            })
            document.getElementById("Child7").addEventListener("click",function(){
                switchData(7);
            })
            document.getElementById("Child8").addEventListener("click",function(){
                switchData(8);
            })
            document.getElementById("Child9").addEventListener("click",function(){
                switchData(9);
            })
            document.getElementById("parent").addEventListener("click",function(){
                switchData(-1);
            })
        }

        function initializePathAxis(){
            // calculate a axis for each dimension
            // base on x axis of each path
            Array.prototype.forEach.call(document.getElementsByTagName("path"),function(path){
                var x = (path.getBoundingClientRect().left + path.getBoundingClientRect().right) / 2
                pathes.push(x);
            })
        }

        function initializeZooming() {   
            // Firefox and other browser use different way to control mouse scroll           
            if(navigator.userAgent.indexOf("Firefox") > -1){
                // if is Firefox
                document.getElementById("example").addEventListener("DOMMouseScroll", function(event) {
                    // -3 means scroll in
                    if(event.detail == -3){
                        // loop through axis of each dimension
                        pathes.forEach(function(xs,i){
                            // larger means it should zoom in to dimension before
                            if(event.x < xs){
                                switchData(i-1);
                            }
                        })
                    }
                    else{
                        switchData(-1);
                    }
                });
            }
            else {
                document.getElementById("example").onmousewheel = function (event) {
                    event = event || window.event;
                    if(event.wheelDelta > 0){
                        pathes.forEach(function(xs,i){
                            if(event.x < xs){
                                switchData(i-1);
                            }
                        })
                    }
                    else{
                        switchData(-1);
                    }
                }
            }
        }

    </script>

</body>
