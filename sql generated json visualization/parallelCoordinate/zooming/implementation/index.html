<!doctype html>
<meta charset="utf-8"/>
<title>Linking to Data Table</title>
<link rel="stylesheet" type="text/css" href="lib/d3.parcoords.css">
<link rel="stylesheet" type="text/css" href="lib/style.css">
<link rel="stylesheet" type="text/css" href="lib/d3.slider.css">
<style>
/* data table styles */
    #grid { height: 198px; width: 600px;}   /* grid width 200*/
    .row, .header { clear: left; font-size: 20px; line-height: 20px; height: 25px; }  /* row height 30*/
    .row:nth-child(odd) { background: rgba(0,0,0,0.05); }
    .header { font-weight: bold; line-height: 20px; font-size: 25px; height: 40px}
    .cell { float: left; overflow: hidden; white-space: nowrap; width: 200px; height: 22px; }
    .col-0 { width: 100px; }

    table {
      width: 90%;
      position: absolute; left:60px; bottom: 100px;
      font-size: 20px
    }
    th, td {
       text-align: center;
    }

</style>
<script src="lib/d3.min.js"></script>
<script src="lib/sylvester.src.js"></script>
<script src="lib/d3.parcoords.js"></script>
<script src="lib/divgrid.js"></script>
<script src="lib/d3.slider.js"></script>
<!-- use child for zooming, futrue add zooming-->
<button id="Child0">switch first 10% child!</button>
<button id="Child1">switch second 10% child!</button>
<button id="Child2">switch third 10% child!</button>
<button id="Child3">switch fourth 10% child!</button>
<button id="Child4">switch fifth 10% child!</button>
<button id="Child5">switch sixth 10% child!</button>
<button id="Child6">switch seventh 10% child!</button>
<button id="Child7">switch eighth 10% child!</button>
<button id="Child8">switch ninth 10% child!</button>
<button id="Child9">switch tenth 10% child!</button>
<button id="parent">switch parent!</button>
<div id="example" class="parcoords" style="height:350px;"></div>
<div id="grid" style="position: relative; top:20px"></div>
<script id="brushing">

    var blue_to_brown = d3.scale.linear()
        .domain([0, 1000])
        .range(["steelblue", "brown"])
        .interpolate(d3.interpolateLab);

    var color = function(d) { return blue_to_brown(d["Name"]); };

    var parcoords = d3.parcoords()("#example")
        .color(color)
        .alpha(0.4);

    // copy of data load from data set
    var data;
    // current axis set
    var current_data;
    // max number of dimension shown in pc
    var max_dimension = 10;
    // total dimension of system
    var dimension;
    // record current level 
    var level;
    // final level achievable (log10(dimension))
    var final_level;
    // record index of parent
    var parent_index = []; 
    // record index of current data
    var current_index;
    //start revision of system
    var start_point;
    // end revision of system
    var end_point;
    // record current paris exist ()
    var current_pair;
    // parallel coordinate each path x axis
    var pathes = [];
    
//*******************************************************************************
// Main Function: load json file and read datafor visualise***
//*******************************************************************************
    d3.json('data/camellia.json', function(raw_data) {

        // initialize global variable
        data = Object.assign(raw_data.clone_evolution)
        start_point = raw_data.min_revision
        end_point = raw_data.max_revision
        dimension = end_point-start_point+1
        level = 0;
        final_level = Math.round(Math.log10(dimension));
        current_index = 0;
        current_pair = {};

        // modify data to fit first level
        current_data = [];
        for(var i=0;i<raw_data.clone_evolution.length;i++){
            current_data.push(re_data(start_point,end_point,raw_data.clone_evolution[i]))
        }

        // initialize parallel coordinate
        parcoords
            .data(current_data)
            .hideAxis(["Name","StartRevision","EndRevision"])
            .smoothness(0)
            .nullValueSeparator("bottom")
            .render()
            .brushMode("1D-axes");

    //************************************************
    // create data table, row hover highlighting *****
    //************************************************
        var grid = d3.divgrid(["Name","StartRevision","EndRevision"]);
        d3.select("#grid")
            .datum(current_data.slice(0,20))
            .call(grid)
            .selectAll(".row")
            // TODO
            .on('click', function(d) { alert(d["Name"])})
            .on({
                "mouseover": function(d) { parcoords.highlight([d]) },
                "mouseout": parcoords.unhighlight
            });

    //************************************************
    // update data table on brush event **************
    //************************************************
        parcoords.on("brush", function(d) {
            d3.select("#grid")
                .datum(d.slice(0,20))
                .call(grid)
                .selectAll(".row")
                // TODO
                .on('click', function(d) { alert(d["Name"])})
                .on({
                    "mouseover": function(d) { parcoords.highlight([d]) },
                    "mouseout": parcoords.unhighlight
                });
        });

        // add event listener to each button
        // will remove in future, using zooming
        document.getElementById("Child0").addEventListener("click",function(){
            switchData(0);
        })
        document.getElementById("Child1").addEventListener("click",function(){
            switchData(1);
        })
        document.getElementById("Child2").addEventListener("click",function(){
            switchData(2);
        })
        document.getElementById("Child3").addEventListener("click",function(){
            switchData(3);
        })
        document.getElementById("Child4").addEventListener("click",function(){
            switchData(4);
        })
        document.getElementById("Child5").addEventListener("click",function(){
            switchData(5);
        })
        document.getElementById("Child6").addEventListener("click",function(){
            switchData(6);
        })
        document.getElementById("Child7").addEventListener("click",function(){
            switchData(7);
        })
        document.getElementById("Child8").addEventListener("click",function(){
            switchData(8);
        })
        document.getElementById("Child9").addEventListener("click",function(){
            switchData(9);
        })
        document.getElementById("parent").addEventListener("click",function(){
            switchData(-1);
        })

        Array.prototype.forEach.call(document.getElementsByTagName("path"),function(path){
            var x = (path.getBoundingClientRect().left + path.getBoundingClientRect().right) / 2
            pathes.push(x);
        })
        
        if(navigator.userAgent.indexOf("Firefox") > -1){
            document.getElementById("example").addEventListener("DOMMouseScroll", function(event) {
                if(event.detail == -3){
                    pathes.forEach(function(xs,i){
                        if(event.x < xs){
                            switchData(i-1);
                        }
                    })
                }
                else{
                    switchData(-1);
                }
            });
        }
        else {
            document.getElementById("example").onmousewheel = function (event) {
                event = event || window.event;
                if(event.wheelDelta > 0){
                    pathes.forEach(function(xs,i){
                        if(event.x < xs){
                            switchData(i-1);
                        }
                    })
                }
                else{
                    switchData(-1);
                }
            }
        }

        

  });

    function re_data(start,end,chain){
        // returned data
        var newData = {};
        var j = 0;
        var temp_dimension;
        if(max_dimension < end-start){
            temp_dimension = max_dimension
        }
        else{
            temp_dimension = end-start
        }
        for(var i=0;i<=temp_dimension;i++){
            var index;
            // avoid situation divided by 0 
            if( i == 0 ){
                index = start;
            }
            else {
                // calculate index by range*i/10+start
                index = Math.round((end-start)/temp_dimension*i+start);
            }
            var sum = 0;
            var num = 0;
            for(;j<index;j++){
                var changecount = chain[j];
                if (changecount>-1){
                    sum+=changecount;
                    num++;
                }
            }
            if(num == 0){
                newData[index] = -1;
            }
            else{
                newData[index] = Math.round(sum/num);
            }
            j = index;
        }
        newData["Name"] = chain["Name"];
        newData["StartRevision"] = chain ["StartRevision"];
        newData["EndRevision"] = chain["EndRevision"];
        return newData;
    }

    function switchData(where){
        // should not zoom out at root level
        if(level == 0 && where == -1){
            return;
        }
        if(level == final_level && where != -1){
            return;
        }
        // clear current display
        var myNode = document.getElementById("example");
        while (myNode.firstChild) {
            myNode.removeChild(myNode.firstChild);
        }

        parcoords = d3.parcoords()("#example")
            .color(color)
            .alpha(0.4);

        new_data = Object.assign(data)

        var start_index,
            end_index;

        if(where == -1){
            level--;
            var parent = parent_index.pop();
            current_index = parent;
            start_index = Math.round((dimension/Math.pow(10,level))*(parent)+start_point);
            end_index = Math.round((dimension/Math.pow(10,level))*(parent+1)+start_point);
            if(end_index> dimension){
                end_index = dimension;
            }
        }
        else{
            parent_index.push(current_index);
            current_index = where;
            level++;
            // get start / end popint from data form last time
            start_index = parseInt(Object.keys(current_data[0])[where]);
            end_index = parseInt(Object.keys(current_data[0])[where+1]);
        }

        var mod_data = [];

        for(var i=0;i<new_data.length;i++){
            mod_data.push(re_data(start_index,end_index,new_data[i]))
        }

        current_data = mod_data

        parcoords
            .data(mod_data)
            .hideAxis(["Name","StartRevision","EndRevision"])
            .nullValueSeparator("bottom")
            .render()
            .brushMode("1D-axes");  


        //************************************************
        // create data table, row hover highlighting *****
        //************************************************
        var grid = d3.divgrid(["Name","StartRevision","EndRevision"]);
        d3.select("#grid")
            .datum(mod_data.slice(0,20))
            .call(grid)
            .selectAll(".row")
            // TODO
            .on('click', function(d) { alert(d["Name"])})
            .on({
                "mouseover": function(d) { parcoords.highlight([d]) },
                "mouseout": parcoords.unhighlight
            });

        //************************************************
        // update data table on brush event **************
        //************************************************
        parcoords.on("brush", function(d) {
            d3.select("#grid")
                .datum(d.slice(0,20))
                .call(grid)
                .selectAll(".row")
                // TODO
                .on('click', function(d) { alert(d["Name"])})
                .on({
                    "mouseover": function(d) { parcoords.highlight([d]) },
                    "mouseout": parcoords.unhighlight
                });
        });

    }

</script>

