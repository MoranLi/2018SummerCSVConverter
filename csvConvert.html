<html>
  <head>

  </head>
  <body>
    <script>
      // variable store user`s input file object
      var NicadReport;
      var GcadReport;
      // variable to store path information
      var dataCollection = [[]];
      // find common substring to find path
      function findCommonSubstring(s1, s2){
        for(var i=0;i<Math.min(s1.length,s2.length);i++){
          if(s1[i] !== s2[i]){
            return s1.subString(0,i-1);
          }
        }
      }
      // initialize file object with check file type of file user uploaded
      function initializeFile(){
        Nicad = document.getElementById("NicadFile").files[0];
        Gcad = document.getElementById("GcadFile").files[0];
        // check uploaded file type
        if(Nicad.type !== "text/html" || Gcad.type !== "text/plain"){
          alert("illegal File type");
          return false;
        }
        else{
          NicadReport = Nicad;
          GcadReport = Gcad;
          return true;
        }
      }
      // csv generate example: https://jsfiddle.net/jossef/m3rrLzk0/
      function exportToCsv(filename, rows) {
        var processRow = function (row) {
            var finalVal = '';
            for (var j = 0; j < row.length; j++) {
                var innerValue = row[j] === null ? '' : row[j].toString();
                if (row[j] instanceof Date) {
                    innerValue = row[j].toLocaleString();
                };
                var result = innerValue.replace(/"/g, '""');
                if (result.search(/("|,|\n)/g) >= 0)
                    result = '"' + result + '"';
                if (j > 0)
                    finalVal += ',';
                finalVal += result;
            }
            return finalVal + '\n';
        };
        var csvFile = '';
        for (var i = 0; i < rows.length; i++) {
            csvFile += processRow(rows[i]);
        }
        var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
        if (navigator.msSaveBlob) { // IE 10+
            navigator.msSaveBlob(blob, filename);
        } else {
            var link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                // Browsers that support HTML5 download attribute
                var url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    }
      // initialize file and load content to dom
      function ReadFile(){
        // if load file fail, quit
        if(!initializeFile()){
          return;
        }
        // read NicadReport
        // FileReader usage example: https://stackoverflow.com/questions/12371970/read-text-file-using-filereader
        var reader = new FileReader();
        reader.onload = function(event)
        {
            var contents = event.target.result;
            var lines = contents.split('\n');
            // add content to div for future dom usage
            document.getElementById("readResult").innerHTML=contents;
            // select paths for build path tree
            var tds = document.getElementsByTagName("td");
            for(var i=0;i<tds.length;i++){
              // path information
              var pathLine = tds[i].childNodes[0].data;
              // 25 is counted from pathLine.split() result
              var path = pathLine.split(" ")[25].split("/");
              path.forEach(function(p,j){
                if(j == 0){
                  dataCollection[j].push(" ")
                }
                else{
                  if(dataCollection[j] === undefined){
                    dataCollection.push([]);
                    for(var k = 0;k<i;k++){
                      dataCollection[j].push(" ")
                    }
                  }
                  if(j==path.length-1 && j<dataCollection.length-1){
                    for(var m = j+1;m<dataCollection.length;m++){
                      dataCollection[m].push(" ")
                    }
                  }
                  dataCollection[j].push(p);
                }
              })
            }
            for(var i =dataCollection[dataCollection.length-1].length;i<dataCollection[dataCollection.length-2].length;i++){
              dataCollection[dataCollection.length-1].push("")
            }
            dataCollection.push([])
            dataCollection.push([])
            for(var i=0;i<tds.length;i++){
              // code information
              var code = tds[i].childNodes[1].innerText;
              var cloneclass = tds[i].parentNode.parentNode.parentNode.previousElementSibling.innerText.split(" ")[2];
              // remove last comma
              var cloneClassNumber = cloneclass.substring(0,cloneclass.length-1);
              dataCollection[dataCollection.length-1].push(code)
              dataCollection[dataCollection.length-2].push(cloneClassNumber)
            }
            exportToCsv("data.csv",dataCollection)
        };
        reader.readAsText(NicadReport);
        console.log(dataCollection);
        let csvContent = "data:text/csv;charset=utf-8,";
        dataCollection.forEach(function(rowArray){
          console.log(rowArray)
          let row = rowArray.join(",");
          console.log(row)
          csvContent += row + "\r\n";
        }); 
        console.log(csvContent)
        //var encodedUri = encodeURI(csvContent);
        //window.open(encodedUri);
        // exportToCsv("data.csv",dataCollection)
      }
    </script>
    <div>
      <label>Submit Nicad Clone Report</label><input id="NicadFile" name="cloneReport" type="file" accept=".html">
      <label>Submit Gcad Report</label><input id="GcadFile" name="cloneReport" type="file" accept=".txt">
      <button onclick="ReadFile()">Submit</button> 
    </div>
    <div id="readResult"></div>
    <div id="pathResult"></div>
  </body>
</html>